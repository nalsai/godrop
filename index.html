<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload with Progress Bar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        .drop-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            cursor: pointer;
        }

        .drop-area.highlight {
            border-color: #d35977;
        }

        .poiner-events-none {
            pointer-events: none;
        }
        
        body {
            background-color: #1e1e1e;
            color: #fff;
            --bs-body-bg: #1b1819;
        }

        .progress {
            --bs-progress-bar-bg: #9d1246;
        }

        .btn-adwaita-primary {
            --bs-btn-color: #fff;
            --bs-btn-bg: #3584e4;
            --bs-btn-border-color: #3584e4;
            --bs-btn-hover-color: #fff;
            --bs-btn-hover-bg: #78aeed;
            --bs-btn-hover-border-color: #78aeed;
            --bs-btn-focus-shadow-rgb: 13,110,253;
            --bs-btn-active-color: #fff;
            --bs-btn-active-bg: #2a6ab6;
            --bs-btn-active-border-color: #2a6ab6;
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
            --bs-btn-disabled-color: #2a6ab6;
            --bs-btn-disabled-bg: transparent;
            --bs-btn-disabled-border-color: #0d6efd;
        }

        .btn-pink-primary {
            --bs-btn-color: #fff;
            --bs-btn-bg: #9d1246;
            --bs-btn-border-color: #9d1246;
            --bs-btn-hover-color: #fff;
            --bs-btn-hover-bg: #c41154;
            --bs-btn-hover-border-color: #c41154;
            --bs-btn-focus-shadow-rgb: 255,105,180;
            --bs-btn-active-color: #fff;
            --bs-btn-active-bg: #d8135c;
            --bs-btn-active-border-color: #d8135c;
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
            --bs-btn-disabled-color: #d35977;
            --bs-btn-disabled-bg: transparent;
            --bs-btn-disabled-border-color: #d35977;
        }
    </style>
</head>

<body>
    <div class="container my-5">
        <div id="app">
            <h1 class="">Upload all your files here!</h1>
            <p class="mb-4">I swear I will treat them well.</p>
            <label for="fileInput" class="d-block drop-area" @dragover.prevent="dragOver" @dragenter.prevent="dragEnter"
                @dragleave.prevent="dragLeave" @drop.prevent="dropFiles"> <!-- TODO: disable while uploading-->
                <p class="poiner-events-none mb-1">Drag and drop your files here</p>
                <p class="poiner-events-none small mb-0">or click to select files</p>
                <input class="d-none" type="file" ref="fileInput" id="fileInput" @change="handleFileUpload" multiple :disabled="uploading">
            </label>

            <p class="mt-3">or <span class="btn btn-sm btn-secondary rounded-5" onclick="document.getElementById('dirInput').click()">select a directory</span> to upload all files inside it</p>

            <div class="my-3">
                <input class="d-none" type="file" ref="dirInput" id="dirInput" @change="handleDirectoryUpload" webkitdirectory mozdirectory :disabled="uploading">
            </div>

            <hr class="my-4">

            <div class="text-center">
                <div @click="uploadFiles" class="btn btn-pink-primary rounded-5 px-4 py-2 mb-3" :class="{ 'disabled': files.length === 0 || uploadFinished }">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                    </svg>&nbsp;
                    Upload Files
                </div>
            </div>

            <div v-if="files.length > 0">
                <div v-for="(file, index) in files" :key="index" class="card my-3">
                    <div class="card-body">
                        <p>
                            <span class="text-secondary">{{ index+1 }}. </span>
                            {{ file.name }} <span class="text-secondary">- {{ file.size > 0.1 ? file.size : '0.01' }} MiB</span> <span v-if="file.message.length > 0"><span class="text-secondary">- </span>{{ file.message }} </span>
                            <button v-if="!uploading" type="button" class="btn-close float-end" aria-label="remove file" @click="removeFile(index)"></button>
                        </p>
                        <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="25" aria-valuemin="0"
                            aria-valuemax="100">
                            <div class="progress-bar" :style="{ width: file.progress + '%' }"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    files: [],
                    uploadFinished: false,
                    uploading: false
                };
            },
            methods: {
                dragOver(event) {
                    event.preventDefault();
                },
                dragEnter(event) {
                    event.preventDefault();
                    event.target.classList.add('highlight');
                },
                dragLeave(event) {
                    event.target.classList.remove('highlight');
                },
                dropFiles(event) {
                    event.preventDefault();
                    event.target.classList.remove('highlight');
                    const files = event.dataTransfer.files;
                    //this.$refs.dirInput.value = null;
                    this.handleFiles(files);
                },
                handleFileUpload() {
                    const files = this.$refs.fileInput.files;
                    //this.$refs.dirInput.value = null;
                    this.handleFiles(files);
                },
                handleDirectoryUpload() {
                    const files = this.$refs.dirInput.files;
                    //this.$refs.fileInput.value = null;
                    this.handleFiles(files);
                },
                handleFiles(files) {
                    //console.log('Files selected:', files);
                    this.$set(this, 'uploadFinished', false);
                    this.files = Array.from(files).map((f, i) => ({
                        file: f,
                        name: f.name,
                        size: (f.size / 1024 / 1024).toFixed(2), // in MiB
                        message: '',
                        progress: 0
                    }));
                },
                removeFile(index) {
                    this.$delete(this.files, index);
                },
                uploadFiles() {
                    if (this.files.length === 0) {
                        alert('Please select files to upload');
                        return;
                    }
                    if (this.uploading) {
                        alert('A file upload is already in progress');
                        return;
                    }

                    this.uploading = true;
                    const concurrentUploads = 4;
                    let currentIndex = 0;
                    let currentUploads = 0;

                    // start concurrentUploads number of uploads
                    // if a file is done, start a new upload

                    const uploadNext = () => {
                        currentUploads++;

                        let myfile = this.files[currentIndex];

                        const formData = new FormData();
                        //console.log('Uploading file:', myfile.file);
                        formData.append('file', this.files[currentIndex].file);
                        const xhr = new XMLHttpRequest();

                        const self = this; // Capture the reference to 'this'

                        xhr.upload.addEventListener('progress', (function (i) {
                            return function (event) {
                                if (event.lengthComputable) {
                                    const progress = ((event.loaded / event.total) * 100).toFixed(2);

                                    //console.log(currentIndex, i, progress);
                                    self.$set(myfile, 'progress', progress);
                                }
                            };
                        })(currentIndex));

                        xhr.onreadystatechange = () => {
                            if (xhr.readyState === XMLHttpRequest.DONE) {
                                if (xhr.status === 200) {
                                    //console.log('Upload successful with response', xhr.responseText);
                                    self.$set(myfile, 'message', xhr.responseText);

                                } else {
                                    console.error('Upload failed for file:', myfile);
                                    self.$set(myfile, 'message', xhr.responseText);
                                }

                                currentUploads--;
                                if (currentIndex === self.files.length) {
                                    //console.log('All files uploaded');
                                    self.uploading = false;
                                    self.uploadFinished = true;
                                    return;
                                }

                                // File uploaded successfully
                                if (currentIndex < self.files.length) {
                                    uploadNext(); // Upload the next file
                                }
                            }
                        };

                        xhr.open('POST', '/upload', true);
                        xhr.send(formData);

                        currentIndex++;
                    };

                    while (currentUploads < concurrentUploads && currentIndex < this.files.length) {
                        uploadNext();
                    }
                }
            }
        });
    </script>
</body>

</html>